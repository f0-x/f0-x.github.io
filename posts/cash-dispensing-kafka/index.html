<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Scalable Transactions Processing via Kafka Concurrency - Sushant Rajbanshi</title><meta name="description" content="Welcome to my Code Blog"><meta property="og:title" content="Scalable Transactions Processing via Kafka Concurrency" />
<meta property="og:description" content="We&rsquo;ve all experienced that moment of waiting for a transaction to complete. Behind that simple operation lies a complex dance of systems working together. In this post, I&rsquo;ll walk you through how you can tackle the challenge of processing financial(or any other) transactions at scale using Apache Kafka and Python&rsquo;s asyncio.
A common challenge while dealing with distributed financial systems - how to allow multiple transactions to happen simultaneously across different locations while making sure we never had conflicting operations at any single processing point." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://f0-x.github.io/posts/cash-dispensing-kafka/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-04-25T00:00:00+01:15" />
<meta property="article:modified_time" content="2025-05-03T11:26:21+05:45" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Scalable Transactions Processing via Kafka Concurrency"/>
<meta name="twitter:description" content="We&rsquo;ve all experienced that moment of waiting for a transaction to complete. Behind that simple operation lies a complex dance of systems working together. In this post, I&rsquo;ll walk you through how you can tackle the challenge of processing financial(or any other) transactions at scale using Apache Kafka and Python&rsquo;s asyncio.
A common challenge while dealing with distributed financial systems - how to allow multiple transactions to happen simultaneously across different locations while making sure we never had conflicting operations at any single processing point."/>
<meta name="application-name" content="丂ㄩ丂卄卂几ㄒ">
<meta name="apple-mobile-web-app-title" content="丂ㄩ丂卄卂几ㄒ"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://f0-x.github.io/posts/cash-dispensing-kafka/" /><link rel="prev" href="https://f0-x.github.io/posts/ts-dev-tries-go/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Scalable Transactions Processing via Kafka Concurrency",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/f0-x.github.io\/posts\/cash-dispensing-kafka\/"
        },"genre": "posts","keywords": "python, asyncio, kafka","wordcount":  1559 ,
        "url": "https:\/\/f0-x.github.io\/posts\/cash-dispensing-kafka\/","datePublished": "2025-04-25T00:00:00+01:15","dateModified": "2025-05-03T11:26:21+05:45","publisher": {
            "@type": "Organization",
            "name": "Sushant Rajbanshi"},"author": {
                "@type": "Person",
                "name": "Sushant Rajbanshi"
            },"description": ""
    }
    </script></head><body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Sushant Rajbanshi">丂ㄩ丂卄卂几ㄒ</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="https://chaudharysushant.com.np" rel="noopener noreffer" target="_blank"> About Me </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fa-solid fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fa-solid fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a class="menu-item" href="/index.xml" title="RSS"><i class="fa-solid fa-rss fa-fw" title="RSS"></i> </a><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fa-solid fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Sushant Rajbanshi">丂ㄩ丂卄卂几ㄒ</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fa-solid fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fa-solid fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="https://chaudharysushant.com.np" title="" rel="noopener noreffer" target="_blank">About Me</a><div class="menu-item"><a href="/index.xml" title="RSS"><i class="fa-solid fa-rss fa-fw" title="RSS"></i> </a>
                <span>&nbsp;|&nbsp;</span><a href="#" onclick="return false;" class="theme-switch" title="Switch Theme">
                    <i class="fa-solid fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/cover-image-transaction-processing.jpeg"
        data-srcset="/posts/cash-dispensing-kafka/images/cover-image-transaction-processing.jpeg, images/cover-image-transaction-processing.jpeg 1.5x, /posts/cash-dispensing-kafka/images/cover-image-transaction-processing.jpeg 2x"
        data-sizes="auto"
        alt="/posts/cash-dispensing-kafka/images/cover-image-transaction-processing.jpeg"
        title="/posts/cash-dispensing-kafka/images/cover-image-transaction-processing.jpeg" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">Scalable Transactions Processing via Kafka Concurrency</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fa-solid fa-user-circle fa-fw"></i>Sushant Rajbanshi</a></span>&nbsp;<span class="post-category">published in <a href="/categories/system-design/"><i class="fa-regular fa-folder fa-fw"></i>system-design</a>&nbsp;<a href="/categories/architecture/"><i class="fa-regular fa-folder fa-fw"></i>architecture</a>&nbsp;<a href="/categories/concurrency/"><i class="fa-regular fa-folder fa-fw"></i>concurrency</a></span></div>
                <div class="post-meta-line"><span><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-04-25">2025-04-25</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;1559 words</span>&nbsp;
                    <span><i class="fa-regular fa-clock fa-fw"></i>&nbsp;8 minutes</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fa-solid fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#my-journey-to-a-solution">My Journey to a Solution</a></li>
    <li><a href="#my-solution-location-based-semaphores-with-asyncio">My Solution: Location-Based Semaphores with Asyncio</a>
      <ul>
        <li><a href="#key-components">Key Components</a></li>
      </ul>
    </li>
    <li><a href="#kafka-integration-and-resilience">Kafka Integration and Resilience</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>We&rsquo;ve all experienced that moment of waiting for a transaction to complete. Behind that simple operation lies a complex dance of systems working together. In this post, I&rsquo;ll walk you through how you can tackle the challenge of processing financial(or any other) transactions at scale using <a href="https://kafka.apache.org/intro#intro_nutshell" target="_blank" rel="noopener noreffer">Apache Kafka</a> and Python&rsquo;s <a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener noreffer">asyncio</a>.</p>
<p>A common challenge while dealing with distributed financial systems - <strong>how to allow multiple transactions to happen simultaneously across different locations while making sure we never had conflicting operations at any single processing point</strong>. The solution I developed combined message streaming with a simple concurrency control mechanism that I&rsquo;ll explain in this blog post.</p>
<div class="details admonition bug open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-bug fa-fw"></i>The Challenge<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Imagine you&rsquo;re managing a network of transaction processing systems across different locations, and you need to handle dozens of operations every second. When I started tackling this problem, I quickly realized several interesting challenges:</p>
<ol>
<li><strong>Concurrent Operations</strong>: How do we process transactions from different locations simultaneously to keep things fast?</li>
<li><strong>Location Safety</strong>: We absolutely can&rsquo;t have multiple operations happening on the same physical system at once - that&rsquo;s how inconsistencies occur!</li>
<li><strong>Fault Tolerance</strong>: If something crashes mid-transaction, we need to recover gracefully</li>
</ol>
</div>
        </div>
    </div>
<h2 id="my-journey-to-a-solution">My Journey to a Solution</h2>
<p>My first approach was implementing multi-threading in Python, but knowing about the <a href="https://leimao.github.io/blog/Python-GIL/" title="Lei&#39;s awesome blog" target="_blank" rel="noopener noreffer">Global Interpreter Lock (GIL)</a> deemed it not a good solution. The GIL prevents <a href="https://stackoverflow.com/a/74936772/6154579" target="_blank" rel="noopener noreffer">true parallel execution</a> of Python threads.</p>
<figure><img src="images/python-gil-meme.png"
         alt="Python GIL Sucks 😭"/><figcaption>
            <p><em>Python GIL Sucks</em> 😭</p>
        </figcaption>
</figure>

<p>I then explored spawning multiple <a href="https://hypercorn.readthedocs.io/en/latest/discussion/workers.html#workers" target="_blank" rel="noopener noreffer">Hypercorn workers</a> to handle transactions concurrently. More workers should mean more throughput, right?</p>
<p>That approach quickly fell apart when I tested it. With multiple workers processing messages independently, I ended up with redundant operations - the same physical system trying to process the same transaction twice! Not exactly what you want in a financial system.</p>
<p>So I swung to the opposite extreme. <em>&ldquo;What if I just make everything strictly synchronous?&quot;</em> Sure, it would be slower, but at least transactions would be recorded properly and we wouldn&rsquo;t have inconsistent states.</p>
<p>But forcing everything to be sequential created a massive bottleneck. Transactions at Location A had to wait for transactions at Location B to complete, even though they had nothing to do with each other. Users were waiting unnecessarily, and the system couldn&rsquo;t scale.</p>
<figure><img src="images/waiting-for-transaction.jpeg"/>
</figure>

<p>That&rsquo;s when I realized I needed something in between - parallel processing where it&rsquo;s safe, but strict controls where it matters.</p>
<h2 id="my-solution-location-based-semaphores-with-asyncio">My Solution: Location-Based Semaphores with Asyncio</h2>
<div class="mermaid" id="id-1"></div>
<p>The heart of our solution combines Kafka&rsquo;s distributed messaging with Python asyncio&rsquo;s concurrency primitives to create a system that processes transactions in parallel while maintaining safety constraints.</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-lightbulb fa-fw"></i>What&#39;s a Semaphore?<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Think of a <a href="https://docs.python.org/3/library/threading.html#semaphore-objects" target="_blank" rel="noopener noreffer">semaphore</a> like a bouncer at a nightclub with a strict capacity limit. If the club can only safely hold 50 people, the bouncer keeps count and only lets new people in when others leave. In programming terms, a semaphore is a variable that controls access to a shared resource by multiple processes - in our case, limiting access to each location&rsquo;s processing system.</div>
        </div>
    </div>
<p>In simpler terms, we built a system that can handle many transactions at once (like a multi-lane highway) but makes sure that no two transactions try to access the same system at the same time (no lane crossing). This gives us speed without sacrificing safety.</p>
<p>Let me walk through the key components:</p>
<h3 id="key-components">Key Components</h3>
<h4 id="1-location-based-concurrency-control">1. Location-Based Concurrency Control</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Dictionary to track region-specific tasks</span>
<span class="n">region_tasks</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># Dictionary to track region-specific semaphores</span>
<span class="n">region_semaphores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># Default maximum concurrent transactions per region</span>
<span class="n">MAX_CONCURRENT_PER_REGION</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div><p>This approach creates a dedicated semaphore for each region, allowing the system to process transactions from different locations in parallel while ensuring only one transaction executes at a time for any given location. Like having independent checkout lines at different momo stalls, customers can get tasty momos served simultaneously across the network, but each individual stall carefully manages its own line to prevent confusion.</p>
<h4 id="2-dynamic-task-management">2. Dynamic Task Management</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Create a semaphore for this region if it doesn&#39;t exist yet</span>
<span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_semaphores</span><span class="p">:</span>
    <span class="n">region_semaphores</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">MAX_CONCURRENT_PER_REGION</span><span class="p">)</span>
    <span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create and track the task</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">execute_with_semaphore</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Think of this part as an organised filing system that automatically creates a new folder the first time we encounter a new location. Then, whenever a customer creates a new transaction, their request gets placed in the appropriate location’s folder and tracked until completion. Once their transaction is done, we remove their paperwork from the folder to keep things tidy — no clutter, no lost transactions.</p>
<h4 id="3-semaphore-protected-processing">3. Semaphore-Protected Processing</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">async</span> <span class="k">def</span> <span class="nf">execute_with_semaphore</span><span class="p">(</span><span class="n">msg_data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">region_semaphores</span><span class="p">[</span><span class="n">region</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">process_message</span><span class="p">(</span><span class="n">msg_data</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up - remove this task from the location&#39;s task list when done</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">region_tasks</span> <span class="ow">and</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]:</span>
            <span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Here’s where the magic happens!🪄Think of this like a security gate that only allows one person through at a time. When a transaction arrives, it waits its turn until it gets the green light to proceed. Once it’s done, it cleans up after itself by removing its record from our tracking system.</p>
<p>The benefit of this approach? Transactions from different locations run simultaneously, but transactions for the same location politely wait their turn. And if something goes wrong, we still clean up properly — no loose ends!</p>
<h2 id="kafka-integration-and-resilience">Kafka Integration and Resilience</h2>
<p>Our solution leverages <a href="https://www.svix.com/resources/guides/kafka-message-queue/#what-makes-kafka-a-unique-message-queue" target="_blank" rel="noopener noreffer">Kafka&rsquo;s robust message queuing capabilities</a>, which forms the backbone of our transaction processing architecture. When a transaction comes in, Kafka ensures it&rsquo;s not lost and can be properly tracked even if something goes wrong. I implemented an idempotent consumer group that processes these messages asynchronously:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">async</span> <span class="k">def</span> <span class="nf">process_messages</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">app_context</span><span class="p">():</span>
                <span class="n">consumer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_consumer</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s2">&#34;transaction-processing-group&#34;</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
                    <span class="c1"># Process message with location-based semaphore protection</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&#34;region&#34;</span><span class="p">])</span>

                    <span class="c1"># Create task with semaphore protection</span>
                    <span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_semaphores</span><span class="p">:</span>
                        <span class="n">region_semaphores</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">MAX_CONCURRENT_PER_REGION</span><span class="p">)</span>
                        <span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">execute_with_semaphore</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">region_tasks</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;Connection lost, attempting to reconnect...&#34;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait before trying again</span>
</code></pre></td></tr></table>
</div>
</div><p>The system handles connection failures gracefully with retry mechanisms and uses a combination of try/except blocks for error handling. If something breaks mid-transaction, our error recovery kicks in:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">    <span class="k">except</span> <span class="n">ConsumerStoppedError</span><span class="p">:</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;Consumer stopped, attempting to restart...&#34;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">cleanup_consumer</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">kafka_consumer</span><span class="p">)</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">kafka_consumer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait before trying again</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Cancel all pending tasks and clean up</span>
        <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">region_tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="c1"># Wait for tasks to complete or be cancelled</span>
        <span class="n">all_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reg_tasks</span> <span class="ow">in</span> <span class="n">region_tasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">all_tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reg_tasks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_tasks</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">all_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>This comprehensive approach means our system automatically restarts after failures, cleans up resources properly during errors, and maintains detailed logs for troubleshooting. Kafka’s distributed nature complements our semaphore approach perfectly — it handles the reliable message delivery while our concurrency controls manage the safe execution of those messages.</p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-check-circle fa-fw"></i>Performance Benefits💪<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>With these implementations, the transaction processing system went from handling just a handful of transactions to processing dozens per second across all our locations simultaneously, while still keeping each individual system records safe from conflicts.</p>
<p>When we first deployed this to production, I was surprised by how much throughput improved. Transactions that used to get backed up during peak hours now sailed through without a hitch. And the best part? We didn’t need to add any extra hardware to make it happen. You’re welcome, DevOps team! 😉</p>
<p>I was particularly nervous about failure scenarios (there’s nothing worse than a financial system incorrectly processing a transaction!), but after a few weeks in production, the error recovery has been rock solid. We’ve had network blips and even a few server restarts, but transactions either complete correctly or roll back safely.</p>
</div>
        </div>
    </div>
<h2 id="conclusion">Conclusion</h2>
<p>So there you have it — by combining Kafka’s distributed messaging with asyncio’s concurrency controls, I built a system that handles financial operations at scale while keeping transactions fast and accurate (till date 🙏)</p>
<figure><img src="images/kafka-complexity.png"
         alt="Managing Kafka is tough 😖"/><figcaption>
            <p><em>Managing Kafka is tough</em> 😖</p>
        </figcaption>
</figure>

<p>Could I have solved this with a simpler approach? Probably. But since Apache Kafka was already the backbone of our microservice architecture, it made sense to leverage what we had rather than introduce yet another technology into the mix. Does Kafka add its own complexity? Absolutely — the learning curve is steep, and operational overhead is real. But for our needs, this complexity was a necessary evil when weighed against the performance and scalability benefits.</p>
<p>This pattern has already proven useful beyond just transaction processing. I have previously applied similar techniques to log generation and storage, where we needed that careful balance between parallelism and safety constraints.</p>
<p>I’m pretty satisfied with how this turned out. Through the use of semaphores, careful task tracking, and robust error handling, I built something that’s both fast and reliable. And when you’re dealing with people’s money, that’s exactly what you need.😉</p>
<p>Let me know your thoughts in the comments below if you spot any error-prone regions in my implementation. I’m curious — how would you approach this problem? Would you go with a similar Kafka + asyncio solution, or take a completely different path? 🤔</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/python/">python</a>
                </span><span><a href="/tags/asyncio/">asyncio</a>
                </span><span><a href="/tags/kafka/">kafka</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>Updated on 2025-05-03&nbsp;<a class="git-hash" href="https://github.com/f0-x/blog/commit/178675444ccc6027338a4e783b1e1378dc84630d" target="_blank" title="committed&nbsp;by&nbsp;f0-x(sus_007@ymail.com)&nbsp;1786754:&nbsp;update: Update post with removal of potentially confidential details">
                            <i class="fa-solid fa-hashtag fa-fw"></i>1786754</a></span>
            </div><div class="post-info-mod"></div>
        </div><div class="post-info-share">
            <span><a href="#" onclick="return false;" title="Share on Twitter" data-sharer="twitter" data-url="https://f0-x.github.io/posts/cash-dispensing-kafka/" data-title="Scalable Transactions Processing via Kafka Concurrency" data-hashtags="python,asyncio,kafka"><i class="fa-brands fa-square-x-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Facebook" data-sharer="facebook" data-url="https://f0-x.github.io/posts/cash-dispensing-kafka/" data-hashtag="python"><i class="fa-brands fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Linkedin" data-sharer="linkedin" data-url="https://f0-x.github.io/posts/cash-dispensing-kafka/"><i class="fa-brands fa-linkedin fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Reddit" data-sharer="reddit" data-url="https://f0-x.github.io/posts/cash-dispensing-kafka/"><i class="fa-brands fa-reddit fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/posts/ts-dev-tries-go/" class="prev" rel="prev" title="Trying GoLang for the first time"><i class="fa-solid fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div><div id="comments" class="single-card"><div id="gitalk"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/">Sushant Rajbanshi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fa-solid fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fa-solid fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/object-fit-images/ofi.min.js"></script><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/lightgallery/lightgallery.min.js"></script><script src="/lib/lightgallery/lg-thumbnail.min.js"></script><script src="/lib/lightgallery/lg-zoom.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script src="/lib/mermaid/mermaid.min.js"></script><script src="/lib/cookieconsent/cookieconsent.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"gitalk":{"admin":["f0-x"],"clientID":"60eb8e8e31fc637ce015","clientSecret":"4a6eaba4e2d62428a8a1c85347e2d5e873a65898","id":"2025-04-25T00:00:00+01:15","owner":"f0-x","repo":"f0-x.github.io","title":"Scalable Transactions Processing via Kafka Concurrency"}},"cookieconsent":{"content":{"dismiss":"Agree","link":"Learn more","message":"Notice. This blog uses cookies to provide necessary website functionality, improve your experience and analyze our traffic. By using our website, you agree to our Privacy Policy and our cookies usage."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"flowchart TD\n    subgraph KafkaBroker[\"Apache Kafka Broker\"]\n        topic[\"Topic: transactions\\nWith Multiple Partitions\"]\n        partitioning[\"Messages Partitioned by Location\\n(Hash of location key)\"]\n        partition0[\"Partition 0\\nLocation A,D,G\"]\n        partition1[\"Partition 1\\nLocation B,E,H\"]\n        partition2[\"Partition 2\\nLocation C,F,I\"]\n\n        topic --\u003e partitioning\n        partitioning --\u003e partition0\n        partitioning --\u003e partition1\n        partitioning --\u003e partition2\n    end\n\n    consumer[\"Python Consumer Service\"]\n    processing[\"Message Processing\"]\n    semaphores[\"Location-Based Semaphores (Control\\nconcurrent processing)\"]\n\n    partition0 --\u003e consumer\n    partition1 --\u003e consumer\n    partition2 --\u003e consumer\n    consumer --\u003e processing\n    processing --\u003e semaphores\n\n    locA[\"Location A\\nProcessing\"]\n    locB[\"Location B\\nProcessing\"]\n    locC[\"Location C\\nProcessing\"]\n\n    semaphores --\u003e locA\n    semaphores --\u003e locB\n    semaphores --\u003e locC\n\n    sysA[\"System\\nLocation A\"]\n    sysB[\"System\\nLocation B\"]\n    sysC[\"System\\nLocation C\"]\n\n    locA --\u003e sysA\n    locB --\u003e sysB\n    locC --\u003e sysC\n\n    compA[\"Complete Transaction\\nLocation A\"]\n    compB[\"Complete Transaction\\nLocation B\"]\n    compC[\"Complete Transaction\\nLocation C\"]\n\n    sysA --\u003e compA\n    sysB --\u003e compB\n    sysC --\u003e compC\n\n    style partition0 fill:#ffccff\n    style partition1 fill:#ffccff\n    style partition2 fill:#ffccff\n    style locA fill:#99ffcc\n    style locB fill:#99ffcc\n    style locC fill:#99ffcc\n    style semaphores fill:#ffffcc"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body></html>
